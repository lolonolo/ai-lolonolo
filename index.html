<script>
        const chatWindow = document.getElementById('chat-window');
        const promptInput = document.getElementById('prompt-input');
        const askButton = document.getElementById('ask-button');
        const newChatBtn = document.getElementById('new-chat-btn');

        // YENİ: Sohbetin modunu takip etmek için bir "hafıza" değişkeni
        let inFallbackMode = false;

        const addMessage = (htmlContent, sender) => {
            const wrapper = document.createElement('div');
            wrapper.classList.add('message-wrapper', sender);

            if (sender === 'assistant') {
                const avatar = document.createElement('div');
                avatar.classList.add('avatar');
                avatar.textContent = 'LN';
                wrapper.appendChild(avatar);
            }

            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.innerHTML = htmlContent;
            
            wrapper.appendChild(messageElement);
            chatWindow.appendChild(wrapper);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return messageElement;
        };

        const sendMessage = async () => {
            const prompt = promptInput.value.trim();
            if (!prompt) return;

            addMessage(prompt, 'user');
            promptInput.value = '';
            promptInput.style.height = 'auto';
            askButton.disabled = true;

            // YENİ MANTIK: Eğer arama modundaysak, API'ye gitme, direkt arama linki oluştur.
            if (inFallbackMode) {
                const searchQuery = encodeURIComponent(prompt);
                const searchUrl = `https://lolonolo.com/?s=${searchQuery}`;
                const searchMessage = `Aradığınız konu için Lolonolo'daki sonuçları burada bulabilirsiniz: <a href="${searchUrl}" target="_blank">${prompt}</a>`;
                
                addMessage(searchMessage, 'assistant');
                
                inFallbackMode = false; // Arama modunu sıfırla
                askButton.disabled = false;
                promptInput.focus();
                return; // Fonksiyonu burada bitir
            }

            const responseElement = addMessage('...', 'assistant');

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt }),
                });

                if (!response.ok) throw new Error('Network response was not ok.');

                const data = await response.json();

                // YENİ: Backend'den gelen özel statüyü kontrol et
                if (data.status === 'fallback_initiated') {
                    inFallbackMode = true; // Arama modunu aktif et
                    promptInput.placeholder = 'Aramak istediğiniz konuyu yazın...';
                }
                
                responseElement.innerHTML = data.reply;

            } catch (error) {
                responseElement.textContent = 'Bir hata oluştu. Lütfen tekrar deneyin.';
                console.error('Fetch Error:', error);
            } finally {
                askButton.disabled = false;
                promptInput.focus();
            }
        };

        const startNewChat = () => {
             chatWindow.innerHTML = '';
             addMessage('Merhaba, ben LOLONOLO. Hangi ders hakkında bilgi almak istemiştiniz?', 'assistant');
             inFallbackMode = false; // Yeni sohbette arama modunu sıfırla
             promptInput.placeholder = 'Bir mesaj yaz...';
        }

        newChatBtn.addEventListener('click', startNewChat);

        askButton.addEventListener('click', sendMessage);
        promptInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });
        
        promptInput.addEventListener('input', () => {
            promptInput.style.height = 'auto';
            promptInput.style.height = `${promptInput.scrollHeight}px`;
        });
        
        startNewChat();
    </script>
