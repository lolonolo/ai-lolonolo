<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lolonolo AI Asistan</title>

    <script>
        window.ezstandalone = window.ezstandalone || {};
        ezstandalone.cmd = ezstandalone.cmd || [];
    </script>
    <script src="//www.ezojs.com/ezoic/sa.min.js" async></script>
    <style>
        /* TÜM CSS STİLLERİ OLDUĞU GİBİ KALIYOR */
        :root {
            --background-color: #F8F9FA; /* ... */
        }
        /* ... */
    </style>
</head>
<body>
    <div class="main-container">
        </div>

    <script>
        // Bizim kodumuz, sayfanın en temel "load" olayını bekleyecek.
        // Bu, Ezoic dahil her şeyin yüklenmesi için zaman tanır.
       window.addEventListener("load", function() {
    setTimeout(function() {
        try {
            const chatWindow = document.getElementById('chat-window');
            const promptInput = document.getElementById('prompt-input');
            const askButton = document.getElementById('ask-button');
            const newChatBtn = document.getElementById('new-chat-btn');

            if (!chatWindow || !promptInput || !askButton || !newChatBtn) {
                console.error("Sohbet arayüzü elementleri bulunamadı. Ezoic muhtemelen HTML yapısını değiştirdi.");
                return;
            }

                let inFallbackMode = false;
                
                // ... Geri kalan tüm JavaScript fonksiyonlarınız (addMessage, sendMessage, startNewChat)
                // olduğu gibi buraya gelecek. Hiçbir değişiklik yok.
                // Sadece en dışına window.addEventListener("load", ...) sarmalayıcısı ekledik.

                const addMessage = (htmlContent, sender) => {
                    const wrapper = document.createElement('div');
                    wrapper.classList.add('message-wrapper', sender);
                    if (sender === 'assistant') {
                        const avatar = document.createElement('div');
                        avatar.classList.add('avatar');
                        avatar.textContent = 'LN';
                        wrapper.appendChild(avatar);
                    }
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('message');
                    messageElement.innerHTML = htmlContent;
                    wrapper.appendChild(messageElement);
                    chatWindow.appendChild(wrapper);
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                    return messageElement;
                };

                const sendMessage = async () => {
                    const prompt = promptInput.value.trim();
                    if (!prompt) return;
                    addMessage(prompt, 'user');
                    promptInput.value = '';
                    promptInput.style.height = 'auto';
                    askButton.disabled = true;

                    if (inFallbackMode) {
                        const searchQuery = encodeURIComponent(prompt);
                        const searchUrl = `https://lolonolo.com/?s=${searchQuery}`;
                        const searchMessage = `Aradığınız konu için Lolonolo'daki sonuçları burada bulabilirsiniz: <a href="${searchUrl}" target="_blank">${prompt}</a>`;
                        addMessage(searchMessage, 'assistant');
                        inFallbackMode = false;
                        askButton.disabled = false;
                        promptInput.focus();
                        promptInput.placeholder = 'Bir mesaj yaz...';
                        return;
                    }

                    const responseElement = addMessage('...', 'assistant');
                    try {
                        const response = await fetch('/api/chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: prompt }),
                        });
                        if (!response.ok) throw new Error('Network response was not ok.');
                        const data = await response.json();
                        if (data.status === 'fallback_initiated') {
                            inFallbackMode = true;
                            promptInput.placeholder = 'Aramak istediğiniz konuyu yazın...';
                        }
                        responseElement.innerHTML = data.reply;
                    } catch (error) {
                        inFallbackMode = true;
                        promptInput.placeholder = 'Aramak istediğiniz konuyu yazın...';
                        responseElement.innerHTML = `Şu an yapay zeka meşgul veya bir sorunla karşılaştı.<br><br>Ancak aradığınız konuyla ilgili Lolonolo'da bir arama yapabilirsiniz. Lütfen aramak istediğiniz konuyu yazın.<br>Örnek: <strong>Anatomi 2025 vize soruları</strong>`;
                    } finally {
                        askButton.disabled = false;
                        promptInput.focus();
                    }
                };

                const startNewChat = () => {
                     chatWindow.innerHTML = '';
                     addMessage('Merhaba, ben LOLONOLO. Hangi ders hakkında bilgi almak istemiştiniz?', 'assistant');
                     inFallbackMode = false;
                     promptInput.placeholder = 'Bir mesaj yaz...';
                }

                newChatBtn.addEventListener('click', startNewChat);
                askButton.addEventListener('click', sendMessage);
                promptInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' && !event.shiftKey) {
                        event.preventDefault();
                        sendMessage();
                    }
                });
                promptInput.addEventListener('input', () => {
                    promptInput.style.height = 'auto';
                    promptInput.style.height = `${promptInput.scrollHeight}px`;
                });
                
                startNewChat();

             } catch(e) {
            console.error("Sohbet uygulaması başlatılamadı:", e);
        }
    }, 1000); // 1 saniye bekler. Bu süreyi duruma göre artırabilirsiniz.
});
    </script>
    
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        if (typeof ezstandalone !== 'undefined') {
            ezstandalone.cmd.push(function() {
                ezstandalone.enable();
                ezstandalone.display();
            });
        }
        // Google Funding Choices Script'i buradan kaldırıp, Ezoic'in kendi sistemine bırakmak daha iyi olabilir.
        // Ama şimdilik test için kalabilir.
    });
    </script>
</body>
</html>
